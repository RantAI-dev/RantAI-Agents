generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Agent model for sales representatives
model Agent {
  id            String         @id @default(cuid())
  email         String         @unique
  name          String
  passwordHash  String
  status        String         @default("OFFLINE") // ONLINE, BUSY, AWAY, OFFLINE
  avatarS3Key   String?        // S3 key for avatar image
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  conversations Conversation[]
}

// Customer model for logged-in customers (nasabah)
model Customer {
  id                String    @id @default(cuid())
  email             String    @unique
  passwordHash      String
  firstName         String
  lastName          String
  phone             String?
  preferredLanguage String    @default("en") // "en" or "id"
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  policies          Policy[]
}

// Policy model - insurance policies owned by customers (only safe data)
model Policy {
  id                String    @id @default(cuid())
  policyNumber      String    @unique
  customerId        String
  customer          Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Product info (safe to display)
  productType       String    // LIFE_INSURANCE, HEALTH_INSURANCE, HOME_INSURANCE
  productTier       String    // "Gold", "Premium", "Basic", etc.
  productName       String    // "Term Life Plus", "Health Gold Plan", etc.

  // Coverage info (safe to display)
  coverageStartDate DateTime
  coverageEndDate   DateTime?
  premiumAmount     Decimal
  premiumFrequency  String    // MONTHLY, QUARTERLY, ANNUAL

  // Payment status (safe to display)
  paymentStatus     String    @default("CURRENT") // CURRENT, OVERDUE, GRACE_PERIOD
  lastPaymentDate   DateTime?
  nextPaymentDate   DateTime?

  // Policy status
  status            String    @default("ACTIVE") // ACTIVE, PENDING, CANCELLED, EXPIRED

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([customerId])
}

// Conversation session between customer and AI/agent
model Conversation {
  id              String    @id @default(cuid())
  sessionId       String    @unique
  status          String    @default("AI_ACTIVE") // AI_ACTIVE, HANDOFF_REQUESTED, WAITING_FOR_AGENT, AGENT_CONNECTED, RESOLVED
  channel         String    @default("PORTAL") // PORTAL, SALESFORCE, WHATSAPP, EMAIL
  externalId      String?   // External system ID (Salesforce Case ID, etc.)
  productInterest String?
  customerName    String?
  customerEmail   String?
  customerPhone   String?
  agentId         String?
  agent           Agent?    @relation(fields: [agentId], references: [id])
  messages        Message[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  handoffAt       DateTime?
  resolvedAt      DateTime?
}

// Individual messages in a conversation
model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String       // USER, ASSISTANT, AGENT, SYSTEM
  content        String
  metadata       String?      // JSON string for channel-specific data (WhatsApp message ID, etc.)
  createdAt      DateTime     @default(now())
  readAt         DateTime?
}

// Callback requests for when no agents are available
model CallbackRequest {
  id              String   @id @default(cuid())
  customerName    String
  customerEmail   String
  customerPhone   String?
  productInterest String?
  notes           String?
  status          String   @default("PENDING") // PENDING, CONTACTED, COMPLETED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Channel configuration for multi-channel agent communication
model ChannelConfig {
  id        String   @id @default(cuid())
  channel   String   @unique // PORTAL, SALESFORCE, WHATSAPP, EMAIL
  enabled   Boolean  @default(false)
  isPrimary Boolean  @default(false)
  config    Json     @default("{}") // Channel-specific configuration
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Feature configuration for enabling/disabling application capabilities
model FeatureConfig {
  id        String   @id @default(cuid())
  feature   String   @unique // AGENT, KNOWLEDGE, CHAT
  enabled   Boolean  @default(true)
  config    Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Organization/Workspace for multi-tenancy
model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique // URL-friendly identifier
  logoUrl     String?          // External URL for logo (backward compat)
  logoS3Key   String?          // S3 key for uploaded logo
  plan        String   @default("free") // free, starter, pro, enterprise

  // Limits based on plan
  maxMembers    Int @default(5)
  maxAssistants Int @default(3)
  maxDocuments  Int @default(100)
  maxApiKeys    Int @default(2)

  // Relationships
  memberships       OrganizationMember[]
  assistants        Assistant[]
  documents         Document[]
  groups            KnowledgeBaseGroup[]
  embedKeys         EmbedApiKey[]
  dashboardSessions DashboardSession[]
  usageRecords      UsageRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Organization membership (links users to orgs)
model OrganizationMember {
  id             String       @id @default(cuid())
  userId         String       // From NextAuth session
  userEmail      String       // For display/invite
  userName       String?      // Cached user name
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           String       @default("member") // owner, admin, member, viewer
  invitedBy      String?      // userId who invited
  invitedAt      DateTime     @default(now())
  acceptedAt     DateTime?    // null = pending invite

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
  @@index([userEmail])
}

// Usage tracking for analytics
model UsageRecord {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?      // Who triggered (optional)

  // What was used
  resourceType String  // "chat", "embedding", "api_call"
  resourceId   String? // assistantId, documentId, etc.

  // Metrics
  tokensInput  Int      @default(0)
  tokensOutput Int      @default(0)
  cost         Decimal? // Estimated cost in USD

  metadata  Json?    // Additional context
  createdAt DateTime @default(now())

  @@index([organizationId, createdAt])
  @@index([resourceType])
}

// AI Assistant configuration for chat
model Assistant {
  id                    String        @id @default(cuid())
  name                  String
  description           String?
  emoji                 String        @default("ðŸ¤–")
  systemPrompt          String        @db.Text
  useKnowledgeBase      Boolean       @default(false)
  knowledgeBaseGroupIds String[]      // Array of KnowledgeBaseGroup IDs
  isSystemDefault       Boolean       @default(false) // Global default assistant
  isBuiltIn             Boolean       @default(false) // Non-deletable built-in assistants

  // Organization scope (null = system/global assistant)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      String?       // userId who created
  updatedBy      String?       // userId who last updated

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
}

// User preferences including default assistant selection
model UserPreference {
  id                 String   @id @default(cuid())
  userId             String   @unique // From NextAuth session
  defaultAssistantId String?  // User's chosen default (overrides system default)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

// Category model for document classification
model Category {
  id        String   @id @default(cuid())
  name      String   @unique // Internal name: "LIFE_INSURANCE", "CUSTOM_CAT"
  label     String            // Display label: "Life Insurance"
  color     String            // Hex color: "#3b82f6"
  isSystem  Boolean  @default(false) // True for default categories (prevent deletion)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Knowledge base groups/folders for organizing documents
model KnowledgeBaseGroup {
  id          String          @id @default(cuid())
  name        String
  description String?
  color       String?         // Hex color for UI display
  documents   DocumentGroup[]

  // Organization scope (null = global/shared)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      String?       // userId who created

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
}

// Junction table for many-to-many Document <-> KnowledgeBaseGroup
model DocumentGroup {
  id        String             @id @default(cuid())
  documentId String
  groupId    String
  document   Document           @relation(fields: [documentId], references: [id], onDelete: Cascade)
  group      KnowledgeBaseGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdAt  DateTime           @default(now())

  @@unique([documentId, groupId])
  @@index([documentId])
  @@index([groupId])
}

// Knowledge base documents for RAG
// Note: Document chunks are stored in SurrealDB for vector search
model Document {
  id          String          @id @default(cuid())
  title       String
  content     String
  categories  String[]        // Array of categories: LIFE_INSURANCE, HEALTH_INSURANCE, HOME_INSURANCE, FAQ, POLICY, GENERAL
  subcategory String?         // Plan names, specific topics
  metadata    Json?           // Additional structured data (legacy: may contain fileData as base64)
  groups      DocumentGroup[]

  // S3 file storage (replaces base64 in metadata)
  s3Key       String?         // S3 object key for original file
  fileType    String?         // "pdf", "image", "markdown"
  fileSize    Int?            // File size in bytes
  mimeType    String?         // MIME type (e.g., "application/pdf")

  // Organization scope (null = global/shared)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      String?       // userId who created

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([s3Key])
}

// API Key for embeddable chat widget
model EmbedApiKey {
  id             String    @id @default(cuid())
  name           String    // Human-readable name (e.g., "Company Website")
  key            String    @unique // Generated API key (e.g., "rantai_live_...")
  assistantId    String    // Assistant to use for this key

  // Domain security
  allowedDomains String[]  // e.g., ["example.com", "*.example.com"]

  // Widget customization (JSON)
  config         Json      @default("{}") // { theme, position, welcomeMessage, avatar, cssClass, launcherButton }

  // Usage tracking
  requestCount   Int       @default(0)
  lastUsedAt     DateTime?

  // Organization scope (required for API keys)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      String?       // userId who created

  // Management
  enabled        Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([key])
  @@index([assistantId])
  @@index([organizationId])
}

// Dashboard chat sessions (separate from widget conversations)
model DashboardSession {
  id          String             @id @default(cuid())
  userId      String             // From NextAuth session
  title       String             @default("New Chat")
  assistantId String
  messages    DashboardMessage[]

  // Organization context (optional - for shared/team chats)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([assistantId])
  @@index([organizationId])
}

// Messages in dashboard chat sessions
model DashboardMessage {
  id          String           @id @default(cuid())
  sessionId   String
  session     DashboardSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  role        String           // "user" or "assistant"
  content     String           @db.Text
  replyTo     String?          // ID of the message being replied to
  editHistory Json?            // Array of { content, assistantResponse, editedAt }
  sources     Json?            // Array of sources for assistant messages
  attachments FileAttachment[] // File attachments for this message
  createdAt   DateTime         @default(now())

  @@index([sessionId])
}

// File attachments stored in S3
model FileAttachment {
  id          String   @id @default(cuid())

  // S3 storage
  s3Key       String   @unique  // S3 object key
  s3Bucket    String   @default("rantai-files")

  // File metadata
  filename    String            // Original filename
  contentType String            // MIME type
  size        Int               // File size in bytes

  // Owner
  uploadedBy  String?           // userId who uploaded

  // Relations (optional - attachment can be orphaned temporarily)
  messageId   String?
  message     DashboardMessage? @relation(fields: [messageId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@index([messageId])
  @@index([uploadedBy])
}
